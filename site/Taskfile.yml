version: "3"

tasks:

  build:
    desc: Build the image
    internal: true
    dir: site
    cmds:
      - |
        docker build -f prod.Dockerfile \
        -t europe-west1-docker.pkg.dev/para-stats/parastats/parastats-site:{{.TAG}} \
        --platform linux/amd64 \
        --build-arg DATABASE_HOST={{.DATABASE_HOST}} \
        --build-arg DATABASE_NAME={{.DATABASE_NAME}} \
        --build-arg DATABASE_PASSWORD={{.DATABASE_PASSWORD}} \
        --build-arg DATABASE_PORT={{.DATABASE_PORT}} \
        --build-arg DATABASE_USER={{.DATABASE_USER}} \
        .

  push:
    desc: Push the image
    internal: true
    dir: site
    requires:
      vars: [ TAG ]
    cmds:
      - docker push europe-west1-docker.pkg.dev/para-stats/parastats/parastats-site:{{.TAG}}

  update-version:
    desc: Update versions in file
    internal: true
    dir: site
    requires:
      vars: [ TAG ]
    cmds:
      - echo "site_tag = \"{{.TAG}}\"" > ../infra/terraform.tfvars

  deploy:
    desc: Deploy site image
    vars:
      TAG: '{{now | unixEpoch}}'
    dir: site
    sources:
      - ./**
      - src/**/*.ts
      - src/**/*.tsx
      - common/**/*.ts
      - exclude: src/**/*.test.ts
    cmds:
      - task: build
        vars:
          TAG:
            ref: .TAG
      - task: push
        vars:
          TAG:
            ref: .TAG
      - task: update-version
        vars:
          TAG:
            ref: .TAG
